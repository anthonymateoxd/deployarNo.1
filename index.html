<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Lector QR con Redirección</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        cursor: pointer;
      }
      #qr-scanner-container {
        margin: 20px 0;
        text-align: center;
      }
      #qr-video {
        border: 2px solid #ddd;
        border-radius: 4px;
        width: 100%;
        max-width: 500px;
      }
      #qr-result {
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
        margin-top: 10px;
      }
      .disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <h1>Lector QR con Redirección</h1>

    <!-- Controles del escáner QR -->
    <div>
      <button id="start-scanner">Iniciar Escáner QR</button>
    </div>

    <div
      id="qr-scanner-container"
      style="display: none"
    >
      <video
        id="qr-video"
        playsinline
      ></video>
      <button
        id="stop-scanner"
        style="margin-top: 10px"
      >
        Detener Escáner
      </button>
      <div
        id="qr-result"
        style="margin-top: 10px"
      ></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
      // Variables para el escáner QR
      let scannerActive = false;
      let videoStream = null;

      document.addEventListener('DOMContentLoaded', function () {
        // Configurar listeners para el escáner QR
        document
          .getElementById('start-scanner')
          .addEventListener('click', startScanner);
        document
          .getElementById('stop-scanner')
          .addEventListener('click', stopScanner);
      });

      // Funciones del escáner QR
      async function startScanner() {
        const scannerContainer = document.getElementById(
          'qr-scanner-container'
        );
        const startScannerBtn = document.getElementById('start-scanner');
        const qrResult = document.getElementById('qr-result');

        scannerContainer.style.display = 'block';
        startScannerBtn.style.display = 'none';
        qrResult.innerHTML = '';

        const video = document.getElementById('qr-video');

        try {
          videoStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' },
          });
          video.srcObject = videoStream;
          video.play();

          scannerActive = true;
          scanQRCode(video);
        } catch (err) {
          console.error('Error al acceder a la cámara:', err);
          qrResult.innerHTML = 'Error al acceder a la cámara: ' + err.message;
        }
      }

      function stopScanner() {
        scannerActive = false;
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
          videoStream = null;
        }
        document.getElementById('qr-scanner-container').style.display = 'none';
        document.getElementById('start-scanner').style.display = 'block';
      }

      function scanQRCode(video) {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        const qrResult = document.getElementById('qr-result');

        function tick() {
          if (!scannerActive) return;

          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const code = jsQR(
              imageData.data,
              imageData.width,
              imageData.height,
              {
                inversionAttempts: 'dontInvert',
              }
            );

            if (code) {
              qrResult.innerHTML = `Código QR escaneado: <strong>${code.data}</strong>`;

              // Verificar si es una URL de YouTube y redirigir
              if (isYouTubeUrl(code.data)) {
                window.location.href = code.data;
              } else {
                qrResult.innerHTML +=
                  '<br><span style="color:red">No es una URL de YouTube válida</span>';
              }

              stopScanner();
            }
          }

          requestAnimationFrame(tick);
        }

        tick();
      }

      function isYouTubeUrl(url) {
        try {
          const parsedUrl = new URL(url);
          return (
            parsedUrl.hostname.includes('youtube.com') ||
            parsedUrl.hostname.includes('youtu.be')
          );
        } catch {
          return false;
        }
      }
    </script>
  </body>
</html>
