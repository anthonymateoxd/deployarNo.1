<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="X-UA-Compatible"
      content="IE=edge"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Lector QR con Google Sheets</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        cursor: pointer;
      }
      #qr-scanner-container {
        margin: 20px 0;
        text-align: center;
      }
      #qr-video {
        border: 2px solid #ddd;
        border-radius: 4px;
      }
      #qr-result {
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Lector QR con Google Sheets</h1>

    <!-- Botones de autenticación -->
    <div>
      <button
        id="authorize_button"
        onclick="handleAuthClick()"
      >
        Authorize
      </button>
      <button
        id="signout_button"
        onclick="handleSignoutClick()"
      >
        Sign Out
      </button>
    </div>

    <!-- Controles del escáner QR -->
    <div>
      <button id="start-scanner">Iniciar Escáner QR</button>
    </div>

    <div
      id="qr-scanner-container"
      style="display: none"
    >
      <video
        id="qr-video"
        width="100%"
        style="max-width: 500px"
      ></video>
      <button
        id="stop-scanner"
        style="margin-top: 10px"
      >
        Detener Escáner
      </button>
      <div
        id="qr-result"
        style="margin-top: 10px"
      ></div>
    </div>

    <!-- Resultados de Google Sheets -->
    <pre
      id="content"
      style="white-space: pre-wrap"
    ></pre>

    <!-- Scripts -->
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script>
      // Variables para Google API
      const CLIENT_ID =
        '124776303655-ciftdp9sqlkm5ir5hargvk1cf9hcte88.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyDz4X52nWMUsWbjO-eyTFx6rNAg82pTb_A';
      const DISCOVERY_DOC =
        'https://sheets.googleapis.com/$discovery/rest?version=v4';
      const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      // Variables para el escáner QR
      let scanner = null;
      let scanningActive = false;

      document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('authorize_button').style.visibility = 'hidden';
        document.getElementById('signout_button').style.visibility = 'hidden';

        // Configurar listeners para el escáner QR
        document
          .getElementById('start-scanner')
          .addEventListener('click', startScanner);
        document
          .getElementById('stop-scanner')
          .addEventListener('click', stopScanner);
      });

      // Funciones de Google API
      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '',
        });
        gisInited = true;
        maybeEnableButtons();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility =
            'visible';
        }
      }

      function handleAuthClick() {
        tokenClient.callback = async resp => {
          if (resp.error !== undefined) {
            throw resp;
          }
          document.getElementById('signout_button').style.visibility =
            'visible';
          document.getElementById('authorize_button').innerText = 'Refresh';
          await listMajors();
        };

        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
          tokenClient.requestAccessToken({ prompt: '' });
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('content').innerText = '';
          document.getElementById('authorize_button').innerText = 'Authorize';
          document.getElementById('signout_button').style.visibility = 'hidden';
        }
      }

      async function listMajors() {
        try {
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: '1a2cs6PGHtxlYL9c6DZJ5v0D5JPAMAONw9RbwmVCHOk0',
            range: 'Datos!A:C',
          });

          const range = response.result;
          if (!range?.values?.length) {
            document.getElementById('content').innerText =
              'No se encontraron datos.';
            return;
          }

          let output = 'Full Name | Email | Tipo de Persona\n';
          output += '------------------------------------\n';

          range.values.forEach((row, index) => {
            if (
              index === 0 &&
              (row[0] === 'Full name' || row[0] === 'Full Name')
            ) {
              return;
            }

            const fullName = row[0] || '';
            const email = row[1] || '';
            const tipoPersona = row[2] || '';

            output += `${fullName} | ${email} | ${tipoPersona}\n`;
          });

          document.getElementById('content').innerText = output;
        } catch (err) {
          console.error(err);
          document.getElementById('content').innerText = err.message;
        }
      }

      // Funciones del escáner QR
      function startScanner() {
        const scannerContainer = document.getElementById(
          'qr-scanner-container'
        );
        const startScannerBtn = document.getElementById('start-scanner');
        const qrResult = document.getElementById('qr-result');

        scannerContainer.style.display = 'block';
        startScannerBtn.style.display = 'none';
        qrResult.innerHTML = '';

        scanner = new Instascan.Scanner({
          video: document.getElementById('qr-video'),
        });

        scanner.addListener('scan', function (content) {
          qrResult.innerHTML = `Código QR escaneado: <strong>${content}</strong>`;
          searchInSheets(content);
          stopScanner();
        });

        Instascan.Camera.getCameras()
          .then(cameras => {
            if (cameras.length > 0) {
              scanningActive = true;
              scanner.start(cameras[0]); // Usar cámara trasera por defecto
            } else {
              qrResult.innerHTML = 'No se encontraron cámaras disponibles';
            }
          })
          .catch(e => {
            console.error(e);
            qrResult.innerHTML = 'Error al acceder a la cámara: ' + e.message;
          });
      }

      function stopScanner() {
        if (scanner && scanningActive) {
          scanner.stop();
          scanningActive = false;
        }
        document.getElementById('qr-scanner-container').style.display = 'none';
        document.getElementById('start-scanner').style.display = 'block';
      }

      async function searchInSheets(qrContent) {
        if (!gapi.client.getToken()) {
          document.getElementById('qr-result').innerHTML +=
            '<br>Debes autenticarte primero';
          return;
        }

        try {
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: '1a2cs6PGHtxlYL9c6DZJ5v0D5JPAMAONw9RbwmVCHOk0',
            range: 'Datos!A:C',
          });

          const range = response.result;
          if (!range?.values?.length) {
            document.getElementById('qr-result').innerHTML +=
              '<br>No hay datos en la hoja';
            return;
          }

          let found = false;
          range.values.forEach((row, index) => {
            if (index === 0) return;

            if (row.some(cell => cell && cell.toString().includes(qrContent))) {
              document.getElementById(
                'qr-result'
              ).innerHTML += `<br>Encontrado en fila ${index + 1}: ${row.join(
                ' | '
              )}`;
              found = true;
            }
          });

          if (!found) {
            document.getElementById('qr-result').innerHTML +=
              '<br>No se encontraron coincidencias';
          }
        } catch (err) {
          console.error(err);
          document.getElementById('qr-result').innerHTML +=
            '<br>Error: ' + err.message;
        }
      }
    </script>
    <script
      async
      defer
      src="https://apis.google.com/js/api.js"
      onload="gapiLoaded()"
    ></script>
    <script
      async
      defer
      src="https://accounts.google.com/gsi/client"
      onload="gisLoaded()"
    ></script>
  </body>
</html>
